<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>مرشد الحرم الاحترافي | محمد الرشيدي</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root { --primary: #1b5e20; --accent: #c69c6d; }
        body { margin: 0; font-family: 'Segoe UI', Tahoma, sans-serif; height: 100vh; overflow: hidden; background: #000; }
        
        #welcome-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://images.unsplash.com/photo-1591604129939-f1efa4d9f7fa?ixlib=rb-1.2.1&auto=format&fit=crop&w=1000&q=80');
            background-size: cover; z-index: 9999; display: flex; flex-direction: column;
            align-items: center; justify-content: center; color: white; text-align: center;
        }

        #map { height: 100vh; width: 100%; }
        
        .top-info {
            position: absolute; top: 15px; left: 10px; right: 10px; z-index: 1000;
            background: rgba(255,255,255,0.9); padding: 12px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 10px;
        }

        .nav-panel {
            position: absolute; bottom: 20px; left: 10px; right: 10px; z-index: 1000;
            display: flex; flex-direction: column; gap: 8px;
        }

        .search-box {
            background: white; border-radius: 15px; padding: 5px;
            display: flex; box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        .search-box input { flex: 1; border: none; padding: 12px; border-radius: 15px; outline: none; font-size: 16px; text-align: right; }

        .dashboard {
            background: var(--primary); color: white; padding: 15px; border-radius: 20px;
            display: flex; justify-content: space-around; text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: 2px solid var(--accent);
        }
        .stat b { display: block; font-size: 22px; color: var(--accent); }
        .stat span { font-size: 12px; }

        .search-results {
            background: white; border-radius: 12px; max-height: 150px; overflow-y: auto;
            display: none; border: 1px solid #ccc;
        }
        .res-item { padding: 12px; border-bottom: 1px solid #eee; color: #333; text-align: right; font-size: 14px; }
    </style>
</head>
<body>

<div id="welcome-screen">
    <h1 style="color: var(--accent);">مرشد الحرم الذكي</h1>
    <p>توجيه حي ومباشر داخل وخارج الحرم</p>
    <button onclick="startApp()" style="background: var(--accent); color: white; border: none; padding: 15px 40px; border-radius: 30px; font-weight: bold; cursor: pointer;">ابدأ الملاحة الآن</button>
</div>

<div class="top-info">
    <div style="width:12px; height:12px; background:#2ecc71; border-radius:50%;"></div>
    <span id="locText" style="font-size: 14px; font-weight: bold; color: #1b5e20;">جاري تحديد موقعك...</span>
</div>

<div id="map"></div>

<div class="nav-panel">
    <div id="resBox" class="search-results"></div>
    <div class="search-box">
        <input type="text" id="destInput" placeholder="ابحث عن وجهتك (باب، مطاف، زمزم...)" oninput="doSearch()">
    </div>
    <div class="dashboard">
        <div class="stat"><b id="dist">0</b><span>متر للهدف</span></div>
        <div class="stat"><b id="steps">0</b><span>خطوة</span></div>
        <div class="stat"><b id="time">0</b><span>دقيقة</span></div>
    </div>
</div>

<script>
    const destinations = [
        { name: "صحن المطاف (الكعبة)", lat: 21.4225, lng: 39.8262 },
        { name: "باب الملك فهد", lat: 21.4214, lng: 39.8235 },
        { name: "باب الملك عبد العزيز", lat: 21.4204, lng: 39.8257 },
        { name: "بداية المسعى (الصفا)", lat: 21.4215, lng: 39.8275 },
        { name: "نهاية المسعى (المروة)", lat: 21.4255, lng: 39.8282 },
        { name: "توسعة الملك عبد الله", lat: 21.4255, lng: 39.8245 },
        { name: "دورات مياه القشاشية", lat: 21.4245, lng: 39.8305 }
    ];

    let map, userMarker, targetMarker, pathLine;
    const haramCenter = [21.4225, 39.8262];

    // إعداد الخريطة بصور القمر الصناعي (Google Hybrid)
    map = L.map('map', { zoomControl: false }).setView(haramCenter, 18);
    
    // استخدام طبقة جوجل ساتلايت
    L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
        maxZoom: 20,
        subdomains:['mt0','mt1','mt2','mt3']
    }).addTo(map);

    pathLine = L.polyline([], {color: '#c69c6d', weight: 5, dashArray: '10, 10'}).addTo(map);

    function startApp() {
        document.getElementById('welcome-screen').style.display = 'none';
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(updatePosition, handleError, {
                enableHighAccuracy: true,
                maximumAge: 0
            });
        }
    }

    function updatePosition(pos) {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const uPos = [lat, lng];

        if (!userMarker) {
            userMarker = L.circleMarker(uPos, {radius: 9, color: 'white', weight: 2, fillOpacity: 1, fillColor: '#007aff'}).addTo(map);
            map.panTo(uPos);
        } else {
            userMarker.setLatLng(uPos);
        }

        // تحديث البيانات إذا كان هناك وجهة مختارة
        if (targetMarker) {
            updateLiveStats(uPos, targetMarker.getLatLng());
        }
        
        document.getElementById('locText').innerText = "أنت الآن في محيط الحرم";
    }

    function updateLiveStats(current, target) {
        let d = map.distance(current, target);
        document.getElementById('dist').innerText = Math.round(d);
        document.getElementById('steps').innerText = Math.round(d / 0.7);
        document.getElementById('time').innerText = Math.round(d / 80); // سرعة المشي المتوسطة
        
        pathLine.setLatLngs([current, target]);
    }

    function doSearch() {
        let q = document.getElementById('destInput').value;
        let resBox = document.getElementById('resBox');
        resBox.innerHTML = '';
        if(!q) { resBox.style.display = 'none'; return; }

        destinations.filter(i => i.name.includes(q)).forEach(i => {
            let div = document.createElement('div');
            div.className = 'res-item';
            div.innerText = i.name;
            div.onclick = () => {
                if(targetMarker) map.removeLayer(targetMarker);
                targetMarker = L.marker([i.lat, i.lng]).addTo(map);
                resBox.style.display = 'none';
                map.fitBounds(L.latLngBounds([userMarker.getLatLng(), [i.lat, i.lng]]), {padding: [50,50]});
            };
            resBox.appendChild(div);
        });
        resBox.style.display = 'block';
    }

    function handleError() {
        alert("يرجى تفعيل الـ GPS لكي يعمل التوجيه الحي");
    }
</script>
</body>
</html>
