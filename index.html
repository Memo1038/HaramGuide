<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>مرشد الحرم الذكي - النسخة النقية</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root { --gold: #c69c6d; --green: #1b5e20; }
        body { margin: 0; font-family: 'Segoe UI', Tahoma, sans-serif; height: 100vh; overflow: hidden; background: #000; }
        
        /* شاشة البداية المحسنة */
        #welcome-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), 
                        url('https://images.unsplash.com/photo-1565019053020-13365846a10a?auto=format&fit=crop&w=1200&q=80');
            background-size: cover; background-position: center;
            z-index: 9999; display: flex; flex-direction: column;
            align-items: center; justify-content: center; color: white; text-align: center;
        }

        .start-btn {
            background: var(--gold); color: white; border: none; padding: 16px 45px;
            border-radius: 50px; font-size: 19px; font-weight: bold; cursor: pointer;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); transition: 0.3s;
        }

        #map { height: 100vh; width: 100%; }

        /* شريط المعلومات العلوي */
        .status-bar {
            position: absolute; top: 15px; left: 10px; right: 10px; z-index: 1000;
            background: rgba(255,255,255,0.95); padding: 14px; border-radius: 15px;
            display: flex; align-items: center; gap: 12px; border: 1px solid var(--gold);
        }

        /* لوحة التحكم السفلية */
        .dash-container {
            position: absolute; bottom: 25px; left: 10px; right: 10px; z-index: 1000;
        }
        
        .search-results {
            background: white; border-radius: 12px; max-height: 180px; overflow-y: auto;
            display: none; border: 1px solid var(--gold); margin-bottom: 10px;
        }
        .res-item { padding: 15px; border-bottom: 1px solid #eee; text-align: right; color: #333; }

        .search-input {
            width: 100%; padding: 16px; border-radius: 15px; border: none;
            box-shadow: 0 5px 25px rgba(0,0,0,0.3); font-size: 16px; margin-bottom: 10px; outline: none;
        }

        .stats-panel {
            background: var(--green); color: white; padding: 15px; border-radius: 20px;
            display: flex; justify-content: space-around; text-align: center;
            border: 2px solid var(--gold);
        }
        .stat-box b { display: block; font-size: 20px; color: var(--gold); }
        .stat-box span { font-size: 11px; opacity: 0.8; }
    </style>
</head>
<body>

<div id="welcome-screen">
    <h1 style="margin: 0;">مساعد الحرم الذكي</h1>
    <p style="margin: 15px 0 30px;">توجيه دقيق في أطهر بقاع الأرض</p>
    <button class="start-btn" onclick="initNavigation()">ابدأ الملاحة الحية</button>
</div>

<div class="status-bar">
    <div style="width:12px; height:12px; background:#2ecc71; border-radius:50%; box-shadow: 0 0 10px #2ecc71;"></div>
    <span id="locStatus" style="font-size: 14px; font-weight: bold; color: var(--green);">جاري الاتصال بالأقمار الصناعية...</span>
</div>

<div id="map"></div>

<div class="dash-container">
    <div id="results" class="search-results"></div>
    <input type="text" class="search-input" id="searchInp" placeholder="ابحث عن الباب، المسعى، المصلى..." oninput="handleSearch()">
    <div class="stats-panel">
        <div class="stat-box"><b id="distVal">0</b><span>متر للهدف</span></div>
        <div class="stat-box"><b id="stepVal">0</b><span>خطوة متبقية</span></div>
        <div class="stat-box"><b id="timeVal">0</b><span>دقيقة مشي</span></div>
    </div>
</div>

<script>
    const points = [
        { name: "الكعبة المشرفة", lat: 21.4225, lng: 39.8262 },
        { name: "باب الملك فهد", lat: 21.4214, lng: 39.8235 },
        { name: "باب الملك عبد العزيز", lat: 21.4204, lng: 39.8257 },
        { name: "جبل الصفا", lat: 21.4215, lng: 39.8275 },
        { name: "جبل المروة", lat: 21.4255, lng: 39.8282 },
        { name: "توسعة الملك عبد الله", lat: 21.4255, lng: 39.8245 }
    ];

    let map, userMkr, targetMkr, line;

    // تهيئة الخريطة بصور عالية الجودة
    map = L.map('map', { zoomControl: false }).setView([21.4225, 39.8262], 18);

    // استخدام محرك خرائط Esri World Imagery (أدق وأصفى من جوجل المجاني في مكة)
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        maxZoom: 19,
        attribution: 'Esri World Imagery'
    }).addTo(map);

    line = L.polyline([], {color: '#c69c6d', weight: 4, dashArray: '5, 10'}).addTo(map);

    function initNavigation() {
        document.getElementById('welcome-screen').style.display = 'none';
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(update, err => alert("فشل تحديد الموقع"), {
                enableHighAccuracy: true
            });
        }
    }

    function update(pos) {
        const uPos = [pos.coords.latitude, pos.coords.longitude];
        
        if (!userMkr) {
            userMkr = L.circleMarker(uPos, {radius: 8, color: '#fff', weight: 2, fillOpacity: 1, fillColor: '#007aff'}).addTo(map);
            map.panTo(uPos);
        } else {
            userMkr.setLatLng(uPos);
        }

        if (targetMkr) {
            let d = map.distance(uPos, targetMkr.getLatLng());
            document.getElementById('distVal').innerText = Math.round(d);
            document.getElementById('stepVal').innerText = Math.round(d / 0.7);
            document.getElementById('timeVal').innerText = Math.round(d / 70);
            line.setLatLngs([uPos, targetMkr.getLatLng()]);
        }
        document.getElementById('locStatus').innerText = "أنت الآن في: محيط الحرم";
    }

    function handleSearch() {
        let q = document.getElementById('searchInp').value;
        let res = document.getElementById('results');
        res.innerHTML = '';
        if(!q) { res.style.display = 'none'; return; }

        points.filter(p => p.name.includes(q)).forEach(p => {
            let d = document.createElement('div');
            d.className = 'res-item';
            d.innerText = p.name;
            d.onclick = () => {
                if(targetMkr) map.removeLayer(targetMkr);
                targetMkr = L.marker([p.lat, p.lng]).addTo(map);
                res.style.display = 'none';
                map.fitBounds(L.latLngBounds([userMkr.getLatLng(), [p.lat, p.lng]]), {padding: [60,60]});
            };
            res.appendChild(d);
        });
        res.style.display = 'block';
    }
</script>
</body>
</html>
