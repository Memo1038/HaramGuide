<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ø±Ø´Ø¯ Ø§Ù„Ø­Ø±Ù… Ø§Ù„Ø°ÙƒÙŠ</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root { --primary: #1b5e20; --accent: #c69c6d; --white: #ffffff; }
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background: #f4f4f4; height: 100vh; display: flex; flex-direction: column; }
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠ */
        .top-status {
            position: absolute; top: 10px; left: 10px; right: 10px; z-index: 1000;
            background: var(--white); padding: 12px; border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 10px;
        }
        .dot { height: 10px; width: 10px; background-color: #ff3b30; border-radius: 50%; display: inline-block; animation: blink 1s infinite; }
        @keyframes blink { 0% {opacity: 1;} 50% {opacity: 0.3;} 100% {opacity: 1;} }

        #map { flex-grow: 1; width: 100%; z-index: 1; }

        /* Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¬Ø°Ø§Ø¨ */
        .search-box {
            position: absolute; top: 75px; left: 10px; right: 10px; z-index: 1000;
        }
        #searchInput {
            width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #ddd;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); font-size: 16px; outline: none; box-sizing: border-box;
        }

        /* Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© Ø§Ù„Ø¹ØµØ±ÙŠØ© */
        .bottom-sheet {
            background: var(--white); padding: 20px; border-radius: 25px 25px 0 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 1000;
        }
        .nav-info { display: flex; justify-content: space-around; margin-bottom: 20px; }
        .info-card { text-align: center; flex: 1; }
        .info-card b { display: block; font-size: 20px; color: var(--primary); }
        .info-card span { font-size: 12px; color: #888; }

        .action-btn {
            width: 100%; background: var(--primary); color: white; border: none;
            padding: 16px; border-radius: 15px; font-weight: bold; font-size: 16px;
            box-shadow: 0 4px 10px rgba(27, 94, 32, 0.3);
        }

        .search-results {
            position: absolute; top: 60px; left: 0; right: 0; background: white;
            border-radius: 10px; max-height: 200px; overflow-y: auto; display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .result-item { padding: 15px; border-bottom: 1px solid #eee; font-weight: 500; }
    </style>
</head>
<body>

<div class="top-status">
    <span class="dot" id="statusDot"></span>
    <span id="userLocationText" style="font-weight: bold; font-size: 14px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…ÙˆÙ‚Ø¹Ùƒ...</span>
</div>

<div class="search-box">
    <input type="text" id="searchInput" placeholder="Ø£ÙŠÙ† ØªØ±ÙŠØ¯ Ø§Ù„Ø°Ù‡Ø§Ø¨ØŸ (Ø²Ù…Ø²Ù…ØŒ Ø¨Ø§Ø¨ØŒ Ø­Ù…Ø§Ù…Ø§Øª...)" oninput="handleSearch()">
    <div id="results" class="search-results"></div>
</div>

<div id="map"></div>

<div class="bottom-sheet">
    <div class="nav-info">
        <div class="info-card"><b id="distText">0</b><span>Ù…ØªØ±</span></div>
        <div class="info-card"><b id="stepText">0</b><span>Ø®Ø·ÙˆØ©</span></div>
        <div class="info-card"><b id="timeText">0</b><span>Ø¯Ù‚ÙŠÙ‚Ø©</span></div>
    </div>
    <button class="action-btn" onclick="startTracking()">ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± ğŸ§­</button>
</div>

<script>
    const locations = [
        { name: "Ø¨Ø§Ø¨ Ø§Ù„Ù…Ù„Ùƒ Ø¹Ø¨Ø¯ Ø§Ù„Ø¹Ø²ÙŠØ² (1)", lat: 21.4204, lng: 39.8257, type: "gate" },
        { name: "Ø¨Ø§Ø¨ Ø§Ù„Ù…Ù„Ùƒ ÙÙ‡Ø¯ (79)", lat: 21.4214, lng: 39.8235, type: "gate" },
        { name: "Ø¨Ø§Ø¨ Ø§Ù„Ø¹Ù…Ø±Ø©", lat: 21.4237, lng: 39.8248, type: "gate" },
        { name: "Ø¬Ø¨Ù„ Ø§Ù„ØµÙØ§", lat: 21.4215, lng: 39.8275, type: "holy" },
        { name: "Ø¬Ø¨Ù„ Ø§Ù„Ù…Ø±ÙˆØ©", lat: 21.4255, lng: 39.8282, type: "holy" },
        { name: "Ø²Ù…Ø²Ù… - Ø§Ù„ØµØ­Ù†", lat: 21.4228, lng: 39.8265, type: "water" },
        { name: "Ø­Ù…Ø§Ù…Ø§Øª Ø§Ù„Ø³Ø§Ø­Ø© Ø§Ù„Ø´Ø±Ù‚ÙŠØ©", lat: 21.4245, lng: 39.8305, type: "wc" }
    ];

    var map = L.map('map', { zoomControl: false }).setView([21.4225, 39.8262], 18);
    var userMarker, polyline = L.polyline([], {color: '#c69c6d', weight: 5}).addTo(map);

    // Ø®Ø±ÙŠØ·Ø© Ø´ÙˆØ§Ø±Ø¹ Ù…Ù„ÙˆÙ†Ø© ÙˆØ£ÙˆØ¶Ø­ Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    function startTracking() {
        if (!navigator.geolocation) {
            alert("Ù…ÙˆØ¨Ø§ÙŠÙ„Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹");
            return;
        }

        navigator.geolocation.watchPosition(success, error, {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0
        });
    }

    function success(pos) {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const currentPos = [lat, lng];

        if (!userMarker) {
            userMarker = L.circleMarker(currentPos, {radius: 10, color: '#007aff', fillOpacity: 1}).addTo(map);
        } else {
            userMarker.setLatLng(currentPos);
        }
        
        document.getElementById('statusDot').style.backgroundColor = '#2ecc71';
        map.panTo(currentPos);
        checkNearest(lat, lng);
    }

    function error() {
        document.getElementById('userLocationText').innerText = "ÙØ´Ù„ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ - ÙØ¹Ù„ Ø§Ù„Ù€ GPS";
    }

    function checkNearest(lat, lng) {
        let nearest = "ÙÙŠ Ø³Ø§Ø­Ø© Ø§Ù„Ø­Ø±Ù…";
        locations.forEach(loc => {
            let d = map.distance([lat, lng], [loc.lat, loc.lng]);
            if (d < 25) nearest = loc.name;
        });
        document.getElementById('userLocationText').innerText = "Ø£Ù†Øª Ø§Ù„Ø¢Ù† ÙÙŠ: " + nearest;
    }

    function handleSearch() {
        let q = document.getElementById('searchInput').value;
        let resDiv = document.getElementById('results');
        resDiv.innerHTML = '';
        if(q.length < 1) { resDiv.style.display = 'none'; return; }

        locations.filter(l => l.name.includes(q)).forEach(loc => {
            let d = document.createElement('div');
            d.className = 'result-item';
            d.innerText = loc.name;
            d.onclick = () => {
                let dest = [loc.lat, loc.lng];
                polyline.setLatLngs([userMarker ? userMarker.getLatLng() : [21.4225, 39.8262], dest]);
                let dist = map.distance(userMarker ? userMarker.getLatLng() : [21.4225, 39.8262], dest);
                document.getElementById('distText').innerText = dist.toFixed(0);
                document.getElementById('stepText').innerText = Math.round(dist / 0.7);
                document.getElementById('timeText').innerText = Math.round(dist / 80) || 1;
                resDiv.style.display = 'none';
                map.fitBounds(polyline.getBounds());
            };
            resDiv.appendChild(d);
        });
        resDiv.style.display = 'block';
    }

    // Ø·Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    window.onload = startTracking;
</script>
</body>
</html>
